<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>プレゼンターモード - Salesforce スライド 01</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Arial', 'Hiragino Sans', 'Meiryo', sans-serif;
            background-color: #2c3e50;
            color: #ecf0f1;
            display: grid;
            grid-template-rows: 60px 1fr 200px;
            height: 100vh;
            overflow: hidden;
        }
        
        .header {
            background-color: #1a2530;
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header h1 {
            font-size: 24px;
            color: white;
        }
        
        .timer {
            font-size: 22px;
            font-weight: bold;
            background-color: rgba(255, 255, 255, 0.1);
            padding: 5px 10px;
            border-radius: 3px;
        }
        
        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            padding: 20px;
            overflow: hidden;
        }
        
        .preview-container {
            background-color: #34495e;
            border-radius: 8px;
            padding: 15px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .preview-header {
            font-size: 18px;
            margin-bottom: 10px;
            color: #3498db;
        }
        
        .current-slide-preview {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background-color: #2c3e50;
            border-radius: 5px;
            overflow: hidden;
        }
        
        .next-slide-preview {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background-color: #2c3e50;
            border-radius: 5px;
            overflow: hidden;
            position: relative;
        }
        
        .slide-image {
            max-width: 100%;
            max-height: 90%;
            object-fit: contain;
        }
        
        .next-label {
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: rgba(52, 152, 219, 0.7);
            color: white;
            padding: 3px 8px;
            border-radius: 3px;
            font-size: 12px;
        }
        
        .notes-container {
            background-color: #34495e;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }
        
        .notes-header {
            font-size: 18px;
            margin-bottom: 10px;
            color: #3498db;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .notes-content {
            background-color: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 5px;
            font-size: 16px;
            line-height: 1.6;
            white-space: pre-wrap;
            flex-grow: 1;
            min-height: 100px;
        }
        
        .notes-textarea {
            background-color: rgba(255, 255, 255, 0.2);
            padding: 15px;
            border-radius: 5px;
            font-size: 16px;
            line-height: 1.6;
            color: #ecf0f1;
            resize: none;
            border: 1px solid #3498db;
            width: 100%;
            font-family: inherit;
            flex-grow: 1;
            min-height: 100px;
            display: none;
        }
        
        .notes-actions {
            display: flex;
            gap: 10px;
        }
        
        .note-btn {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.2s ease;
        }
        
        .note-btn:hover {
            background-color: #2980b9;
        }
        
        .note-btn.save {
            background-color: #2ecc71;
        }
        
        .note-btn.save:hover {
            background-color: #27ae60;
        }
        
        .note-btn.cancel {
            background-color: #e74c3c;
        }
        
        .note-btn.cancel:hover {
            background-color: #c0392b;
        }
        
        .controls {
            background-color: #1a2530;
            padding: 15px 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            width: 100%;
        }
        
        .control-bar {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            flex-wrap: nowrap;
            width: 100%;
            flex-direction: row;
        }
        
        .btn {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.2s ease;
            min-width: 80px;
            text-align: center;
            white-space: nowrap;
        }
        
        .btn:hover {
            background-color: #2980b9;
        }
        
        .btn:disabled {
            background-color: #95a5a6;
            cursor: not-allowed;
        }
        
        .slide-counter {
            font-size: 18px;
            font-weight: bold;
            min-width: 60px;
            text-align: center;
            color: white;
        }
        
        .progress-container {
            width: 100%;
            background-color: rgba(255, 255, 255, 0.1);
            height: 5px;
            position: absolute;
            bottom: 0;
            left: 0;
        }
        
        .progress-bar {
            height: 100%;
            background-color: #3498db;
            width: 0;
        }
        
        .audio-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-right: 20px;
        }
        
        .audio-btn {
            background-color: #e74c3c;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.2s ease;
            min-width: 80px;
            text-align: center;
        }
        
        .audio-btn:hover {
            background-color: #c0392b;
        }
        
        .audio-btn.active {
            background-color: #2ecc71;
        }
        
        .audio-btn.active:hover {
            background-color: #27ae60;
        }
        
        .notification {
            position: fixed;
            bottom: auto;
            top: 80px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(52, 152, 219, 0.9);
            color: white;
            padding: 10px 20px;
            border-radius: 4px;
            z-index: 2000;
            animation: fadeInOut 3s ease-in-out;
            pointer-events: none;
            opacity: 0;
        }
        
        .notification.show {
            opacity: 1;
        }
        
        @keyframes fadeInOut {
            0%, 100% { opacity: 0; }
            10%, 90% { opacity: 1; }
        }

        /* ローディングインジケーターのスタイル */
        .loading-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            color: white;
            font-size: 18px;
        }
        
        .spinner {
            width: 50px;
            height: 50px;
            margin-bottom: 20px;
            border: 5px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .progress-info {
            margin-top: 10px;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="notification" id="notification">通知メッセージ</div>
    
    <!-- ローディングインジケーター -->
    <div class="loading-container" id="loading-container">
        <div class="spinner"></div>
        <div>リソースを読み込み中...</div>
        <div class="progress-info" id="progress-info">0/11 ロード完了</div>
    </div>

    <div class="header">
        <h1>プレゼンター画面 - Salesforce スライド 01</h1>
        <div class="timer" id="timer">00:00</div>
    </div>
    
    <div class="main-content">
        <div class="preview-container">
            <div class="preview-header">現在のスライド</div>
            <div class="current-slide-preview" id="current-slide-preview">
                <img src="" alt="現在のスライド" class="slide-image" id="current-slide-image">
            </div>
        </div>
        
        <div class="preview-container">
            <div class="preview-header">次のスライド</div>
            <div class="next-slide-preview" id="next-slide-preview">
                <div class="next-label">次</div>
                <img src="" alt="次のスライド" class="slide-image" id="next-slide-image">
            </div>
        </div>
        
        <div class="notes-container">
            <div class="notes-header">
                <span>スライドノート</span>
                <div class="notes-actions">
                    <button id="edit-note-btn" class="note-btn">編集</button>
                    <button id="save-note-btn" class="note-btn save" style="display:none;">保存</button>
                    <button id="cancel-note-btn" class="note-btn cancel" style="display:none;">キャンセル</button>
                </div>
            </div>
            <div class="notes-content" id="notes-content">
                ノートが表示されます...
            </div>
            <textarea id="notes-textarea" class="notes-textarea" placeholder="スライドノートを入力してください..."></textarea>
        </div>
    </div>
      <div class="controls">
        <div class="control-bar">
            <button id="prev-btn" class="btn">前へ</button>
            <button id="audio-btn" class="audio-btn">音声再生</button>
            <button id="autoplay-btn" class="btn">自動再生</button>
            <div id="slide-counter" class="slide-counter">1 / 11</div>
            <button id="next-btn" class="btn">次へ</button>
        </div>
    </div>

    <!-- スライドショー共通コアモジュール -->
    <script>
        // スライド共通コアモジュール - プレゼンテーション状態管理
        window.SlideshowCore = {
            // 状態管理
            state: {
                totalSlides: 11,
                currentSlide: 1,
                autoplayEnabled: false,
                audioPlaying: false,
                isTransitioning: false,
                isPresentationMode: true  // プレゼンターモード
            },
            
            // タイマー管理
            timers: {
                autoplayTimeout: null,
                transitionTimeout: null
            },
            
            // 現在の音声要素
            audio: {
                current: null,
                preloaded: []
            },
            
            // 状態変更関数
            setAutoplayState: function(enabled) {
                this.state.autoplayEnabled = enabled;
                window.globalAutoplayState = enabled;
                localStorage.setItem('sf01_autoplayState', enabled ? 'active' : 'inactive');
                console.log(`SlideshowCore: 自動再生状態を ${enabled ? '有効' : '無効'} に設定しました`);
                return enabled;
            },
            
            setSlide: function(slideNumber) {
                if (slideNumber >= 1 && slideNumber <= this.state.totalSlides) {
                    this.state.currentSlide = slideNumber;
                    localStorage.setItem('sf01_currentSlide', slideNumber.toString());
                    console.log(`SlideshowCore: スライドを ${slideNumber} に設定しました`);
                    return true;
                }
                return false;
            },
            
            setAudioPlaying: function(isPlaying) {
                this.state.audioPlaying = isPlaying;
                return isPlaying;
            },
            
            stopAllTimers: function() {
                if (this.timers.autoplayTimeout) {
                    clearTimeout(this.timers.autoplayTimeout);
                    this.timers.autoplayTimeout = null;
                }
                return true;
            },
            
            // 初期化
            initialize: function(isPresentationMode) {
                this.state.isPresentationMode = isPresentationMode;
                
                // ローカルストレージから状態を復元
                const storedAutoplayState = localStorage.getItem('sf01_autoplayState');
                if (storedAutoplayState === 'active') {
                    this.setAutoplayState(true);
                }
                
                const storedSlide = localStorage.getItem('sf01_currentSlide');
                if (storedSlide) {
                    const slideNum = parseInt(storedSlide);
                    if (!isNaN(slideNum) && slideNum >= 1 && slideNum <= this.state.totalSlides) {
                        this.setSlide(slideNum);
                    }
                }
                
                console.log('SlideshowCore: 初期化完了, プレゼンテーションモード:', isPresentationMode);
                return true;
            }
        };
    </script>    <!-- スライド状態リセットスクリプト - 初期状態を確実に設定 -->
    <script src="reset-slide-state.js"></script>
    
    <!-- プレゼンター画面のスタイル修正 - 画像表示問題対策 -->
    <script src="fix-presenter-styles.js"></script>
    
    <!-- プレゼンター画面のスライド表示修正 - 画像読み込み問題対策 -->
    <script src="fix-presenter-slides.js"></script>
    
    <!-- プレゼンター画面の読み込み強化 -->
    <script src="enhance-presenter-loading.js"></script>
    
    <!-- 自動再生状態モニターモジュール - 自動再生状態の一貫性を維持 -->
    <script src="autoplay-monitor.js"></script>
    <script src="presenter-fixes.js"></script>
    
    <!-- エラー防止スクリプト -->
    <script src="error-prevention.js"></script>
    
    <!-- スライド1自動再生修正スクリプト -->
    <script src="slide1-autoplay-fix.js"></script>
    
    <!-- 修正された機能セットを読み込み -->
    <script src="fixed-slides-features.js"></script>
    <!-- 修正された音声再生機能を読み込み -->
    <script src="fixed-playCurrentAudio.js"></script>
    <script>        
        // オーディオの再生/停止を切り替え
        function toggleAudio() {
            if (window.isTogglingAudioPresenter) { // Use a specific flag for presenter
                console.log("Presenter: Audio toggle already in progress.");
                return;
            }
            window.isTogglingAudioPresenter = true;
            console.log('Presenter: toggleAudio called.');

            // 'audioPlaying' in presenter reflects the commanded state or synced actual state.
            // Toggle based on presenter's current belief/commanded state.
            const willPlay = !window.audioPlaying; 

            if (willPlay) {
                console.log('Presenter: Sending PLAY audio command to main screen for slide ' + window.currentSlide);
                sendAudioCommand('play', window.currentSlide); // sendAudioCommand includes current autoplayMode
                
                audioBtn.textContent = '音声停止';
                audioBtn.classList.add('active');
                window.audioPlaying = true; // Presenter's belief of commanded state
                showNotification(`メイン画面にスライド ${window.currentSlide} の音声再生を指示`);

                if (window.SlideshowCore) {
                    window.SlideshowCore.setAudioPlaying(true);
                }
            } else {
                console.log('Presenter: Sending STOP audio command to main screen.');
                sendAudioCommand('stop'); // sendAudioCommand includes current autoplayMode
                
                audioBtn.textContent = '音声再生';
                audioBtn.classList.remove('active');
                window.audioPlaying = false; // Presenter's belief of commanded state
                showNotification('メイン画面に音声停止を指示');

                if (window.SlideshowCore) {
                    window.SlideshowCore.setAudioPlaying(false);
                }
            }

            if (typeof window.globalAudioPlayingState !== 'undefined') {
                window.globalAudioPlayingState = window.audioPlaying;
            }

            setTimeout(() => {
                window.isTogglingAudioPresenter = false;
            }, 200);
        }        
        
        // プレゼンター画面の音声再生と同期処理を改善
        function handleAudioCommand(command) {
            if (!command) return;
            if (command.timestamp && (Date.now() - command.timestamp > 7000)) {
                console.log('Presenter: Stale audio command received, ignoring.', command);
                return;
            }
            if (command.source === 'presenter') {
                return;
            }

            console.log('Presenter: Received audio command:', command);

            const newAudioPlayingState = command.action === 'play';
            const slideNum = command.slide ? parseInt(command.slide) : 0;

            if (newAudioPlayingState) {
                audioBtn.textContent = '音声停止';
                audioBtn.classList.add('active');
                window.audioPlaying = true;
            } else {
                audioBtn.textContent = '音声再生';
                audioBtn.classList.remove('active');
                window.audioPlaying = false;
            }

            if (window.SlideshowCore) {
                window.SlideshowCore.setAudioPlaying(window.audioPlaying);
            }
            if (typeof window.globalAudioPlayingState !== 'undefined') {
                window.globalAudioPlayingState = window.audioPlaying;
            }

            if (command.autoplayState !== undefined) {
                const newAutoplayMode = command.autoplayState;
                if (window.autoplayMode !== newAutoplayMode) {
                    console.log(`Presenter: Syncing autoplay state from audio command: ${newAutoplayMode}`);
                    window.autoplayMode = newAutoplayMode;
                    if (autoplayBtn) {
                        autoplayBtn.textContent = newAutoplayMode ? '自動停止' : '自動再生';
                        if (newAutoplayMode) autoplayBtn.classList.add('active');
                        else autoplayBtn.classList.remove('active');
                    }
                    if (window.SlideshowCore) {
                        window.SlideshowCore.setAutoplayState(newAutoplayMode);
                    }
                    localStorage.setItem('sf01_autoplayState', newAutoplayMode ? 'active' : 'inactive'); // Keep localStorage in sync
                }
            }
            showNotification(`メイン画面の音声状態を同期: ${window.audioPlaying ? '再生中' : '停止中'}`);
        }

        // スライドを変更
        function changeSlide(newSlide) {
            if (isTransitioning) return;
            
            isTransitioning = true;
            
            if (newSlide < 1) newSlide = 1;
            if (newSlide > totalSlides) newSlide = totalSlides;
            
            const wasAutoplayEnabled = window.autoplayMode; // Presenter's autoplayMode
            console.log(`Presenter: Slide change initiated. From ${currentSlide} to ${newSlide}. Autoplay was: ${wasAutoplayEnabled}`);

            // If presenter thought audio was playing, command main screen to stop, and update UI.
            if (window.audioPlaying) {
                console.log('Presenter: Slide changed, sending STOP for previous audio to main screen.');
                sendAudioCommand('stop'); 
                audioBtn.textContent = '音声再生';
                audioBtn.classList.remove('active');
                window.audioPlaying = false;
                if (window.SlideshowCore) {
                    window.SlideshowCore.setAudioPlaying(false);
                }
            }
            
            currentSlide = newSlide;
            
            if (window.SlideshowCore) {
                window.SlideshowCore.setSlide(currentSlide);
            }
            
            localStorage.setItem('sf01_currentSlide', currentSlide.toString());
            
            try {
                sendSyncCommand('slideChange', { slide: currentSlide });
            } catch (error) {
                console.error('Presenter: Slide sync command sending error:', error);
            }
            
            updatePresenterView();
            
            // If presenter's autoplay was on, command main screen to play audio for the new slide.
            if (wasAutoplayEnabled) {
                console.log(`Presenter: Autoplay is ON, slide changed to ${currentSlide}. Informing main screen to play audio.`);
                setTimeout(() => {
                    if (window.autoplayMode) { // Check presenter's autoplayMode again (it might have been changed by another process)
                        console.log(`Presenter: Autoplay still ON. Sending PLAY command for slide ${currentSlide} to main.`);
                        sendAudioCommand('play', currentSlide);
                        // Optimistically update presenter's audio button
                        audioBtn.textContent = '音声停止';
                        audioBtn.classList.add('active');
                        window.audioPlaying = true;
                        if (window.SlideshowCore) {
                             window.SlideshowCore.setAudioPlaying(true);
                        }
                    } else {
                        console.log('Presenter: Autoplay was ON, but now it is OFF. Not sending PLAY command.');
                    }
                }, 500); // Delay to allow slide transition/main screen to process slide change
            }
            
            setTimeout(() => {
                isTransitioning = false;
                if (window.SlideshowCore && window.SlideshowCore.state) {
                    const coreStateAutoplay = window.SlideshowCore.state.autoplayEnabled;
                    if (coreStateAutoplay !== window.autoplayMode) {
                        console.warn('Presenter: Autoplay state mismatch after slide change. Core:', coreStateAutoplay, 'Local:', window.autoplayMode, '. Syncing to core.');
                        window.autoplayMode = coreStateAutoplay;
                        updateAutoplayState(coreStateAutoplay ? 'active' : 'inactive'); // This updates UI and localStorage
                    }
                }
                localStorage.setItem('sf01_lastSlideChangeTime', Date.now().toString());
                localStorage.setItem('sf01_lastKnownSlide', currentSlide.toString());
                
                const event = new CustomEvent('slideChangedPresenter', {
                    detail: { 
                        to: currentSlide,
                        autoplay: window.autoplayMode,
                        audio: window.audioPlaying
                    }
                });
                document.dispatchEvent(event);
            }, 500); // This timeout should match or be slightly longer than the visual transition time.
        }
    </script>      
    <!-- プレゼンター画面用修正スクリプト群 -->
    <script src="fix-presenter-slides.js"></script>
    <script src="fix-presenter-styles.js"></script>
    <script src="audio-sync-fix.js"></script>
    
    <!-- ボタン機能修復スクリプト -->
    <script src="presenter-buttons-fix.js"></script>
    
    <!-- 同期機能の修復スクリプト -->
    <script src="sync-enhanced-fix.js"></script>
    
    <!-- 状態管理の強化スクリプト -->
    <script src="reset-slide-state.js"></script>
    <script src="autoplay-enhanced-fix.js"></script>
    
    <!-- 統合マネージャー - すべての修正を調整 -->
    <script src="slides-integration-manager.js"></script>
      <script>
        // すべてのリソースが読み込まれた後に実行
        window.addEventListener('load', function() {
            console.log('全ての修正スクリプトを適用します');
            
            // 少し遅延させて実行（他のスクリプトの後）
            setTimeout(() => {
                // プレゼンターボタン修正を有効化
                if (window.presenterButtonsFix && typeof window.presenterButtonsFix.reInitialize === 'function') {
                    window.presenterButtonsFix.reInitialize();
                    if (window.slidesManager) window.slidesManager.setFixLoaded('presenterButtons');
                }
                
                // 拡張同期機能を有効化
                if (window.syncFix && typeof window.syncFix.reInitialize === 'function') {
                    window.syncFix.reInitialize();
                    if (window.slidesManager) window.slidesManager.setFixLoaded('enhancedSync');
                }
                
                // スライド表示の修正を確認
                if (window.fixPresenterSlides && typeof window.fixPresenterSlides.reinitialize === 'function') {
                    window.fixPresenterSlides.reinitialize();
                    if (window.slidesManager) window.slidesManager.setFixLoaded('presenterSlides');
                }
                
                // プレゼンタースタイルの適用を登録
                if (window.slidesManager) window.slidesManager.setFixLoaded('presenterStyles');
                
                // 音声同期の修正を適用
                if (window.audioSyncFix && typeof window.audioSyncFix.reinitialize === 'function') {
                    window.audioSyncFix.reinitialize();
                    if (window.slidesManager) window.slidesManager.setFixLoaded('audioSync');
                }
                
                // 自動再生状態の修正を適用 (拡張版)
                if (window.autoplayMode !== undefined) {
                    window.autoplayMode = false;
                    console.log('自動再生を強制的にオフに設定しました');
                    if (window.slidesManager) window.slidesManager.setFixLoaded('enhancedAutoplay');
                }
                
                // 従来の自動再生状態チェックも実行
                if (window.autoplayFix && typeof window.autoplayFix.checkState === 'function') {
                    window.autoplayFix.checkState();
                    if (window.slidesManager) window.slidesManager.setFixLoaded('autoplayState');
                }
                
                // 状態リセット機能を登録
                if (window.slidesManager) window.slidesManager.setFixLoaded('resetState');
                
                console.log('すべての修正が正常に適用されました');
                showNotification('プレゼンター表示の修正が完了しました');
            }, 1000);
        });
    </script>
<script>
/**
 * Salesforceスライドプレゼンテーション - シンプル修正スクリプト (プレゼンター画面用)
 * このスクリプトは直接HTMLに挿入し、既存のフレームワークに依存しません
 */
(function() {
    // 即時実行関数で変数スコープを保護
    
    // 状態管理
    let initialized = false;
    let buttonFixed = false;
    let syncInitialized = false;
    
    // ボタン修復
    function fixButtons() {
        console.log('プレゼンター画面: ボタンの修復を開始します');
        
        try {
            // 修復対象のボタン
            const buttons = {
                'prev-btn': '前へ',
                'next-btn': '次へ',
                'autoplay-btn': '自動再生',
                'sync-btn': '同期'
            };
            
            // 各ボタンを修復
            for (const [id, label] of Object.entries(buttons)) {
                const button = document.getElementById(id);
                if (!button) {
                    console.warn(`ボタン ${id} が見つかりません`);
                    continue;
                }
                
                // ボタンが正しく見えるように設定
                button.style.pointerEvents = 'auto';
                button.style.cursor = 'pointer';
                button.style.position = 'relative';
                button.style.zIndex = '1000';
                
                // 操作性を確保
                button.setAttribute('tabindex', '0');
                
                // 既存のハンドラを保存
                const originalHandler = button.onclick;
                
                // ボタンごとの処理を設定
                button.onclick = function(e) {
                    e.stopPropagation();
                    console.log(`${id} ボタンがクリックされました`);
                    
                    switch(id) {
                        case 'prev-btn':
                            if (window.currentSlide > 1) {
                                window.currentSlide--;
                                changeSlide(window.currentSlide); // 修正: 既存のchangeSlide関数を利用
                            }
                            break;
                            
                        case 'next-btn':
                            if (window.currentSlide < (window.totalSlides || 11)) {
                                window.currentSlide++;
                                changeSlide(window.currentSlide); // 修正: 既存のchangeSlide関数を利用
                            }
                            break;
                            
                        case 'autoplay-btn':
                            // 自動再生切り替え
                            const newAutoplayState = !window.autoplayMode;
                            window.autoplayMode = newAutoplayState;
                            window.globalAutoplayState = newAutoplayState; // グローバル状態も更新
                            if(window.SlideshowCore) window.SlideshowCore.setAutoplayState(newAutoplayState);

                            // UI更新
                            this.textContent = newAutoplayState ? '自動再生停止' : '自動再生';
                            if (newAutoplayState) {
                                this.classList.add('active');
                            } else {
                                this.classList.remove('active');
                            }
                            
                            // 同期: メイン画面にコマンドを送信
                            localStorage.setItem('sf01_autoplayState', newAutoplayState ? 'active' : 'inactive');
                            sendAutoplayCommand(newAutoplayState); // 修正: sendAutoplayCommand を使用
                            showNotification(`自動再生を ${newAutoplayState ? 'オン' : 'オフ'} にしました`);
                            break;
                        // ... sync-btn のケース ...
                    }
                    // 元のハンドラがあれば呼び出す
                    if (typeof originalHandler === 'function') {
                        originalHandler.call(this, e);
                    }
                };
                
                console.log(`${id} ボタンを修復しました`);
            }
            
            buttonFixed = true;
            showStatusNotification('プレゼンターボタンを修復しました');
            
        } catch (e) {
            console.error('ボタン修復中にエラー:', e);
        }
    }
    
    // プレゼンターのビュー更新処理
    function updatePresenterView() {
        try {
            if (typeof window.originalUpdatePresenterView === 'function') {
                // 既存の更新関数があれば呼び出す
                window.originalUpdatePresenterView();
                return;
            }
            
            console.log('プレゼンター画面の更新');
            
            // スライドカウンター更新
            const slideCounter = document.getElementById('slide-counter');
            if (slideCounter) {
                slideCounter.textContent = `${window.currentSlide} / ${window.totalSlides || 11}`;
            }
            
            // 現在のスライド画像を更新
            const currentSlideImage = document.querySelector('.current-slide-preview img');
            if (currentSlideImage) {
                const slidePaddedNumber = String(window.currentSlide).padStart(2, '0');
                currentSlideImage.src = `salesforce_slides/salesforce_slides01/slide${slidePaddedNumber}.png`;
            }
            
            // 次のスライド画像を更新
            const nextSlideImage = document.querySelector('.next-slide-preview img');
            if (nextSlideImage && window.currentSlide < (window.totalSlides || 11)) {
                const nextSlidePaddedNumber = String(window.currentSlide + 1).padStart(2, '0');
                nextSlideImage.src = `salesforce_slides/salesforce_slides01/slide${nextSlidePaddedNumber}.png`;
                nextSlideImage.parentElement.style.display = 'block';
            } else if (nextSlideImage) {
                nextSlideImage.parentElement.style.display = 'none';
            }
            
            // ナビゲーションボタンの状態を更新
            const prevBtn = document.getElementById('prev-btn');
            const nextBtn = document.getElementById('next-btn');
            
            if (prevBtn) prevBtn.disabled = window.currentSlide <= 1;
            if (nextBtn) nextBtn.disabled = window.currentSlide >= (window.totalSlides || 11);
            
        } catch (e) {
            console.error('プレゼンタービュー更新中にエラー:', e);
        }
    }
    
    // メイン画面との同期 (スライド変更時)
    function syncWithMainWindow() {
        // この関数は changeSlide から呼び出される想定
    }
    
    // 自動再生状態の同期コマンド送信
    function sendAutoplayCommand(autoplayState) {
        console.log(`Presenter: Sending autoplay command: ${autoplayState ? 'active' : 'inactive'}`);
        localStorage.setItem('sf01_autoplayCommand', JSON.stringify({
            action: autoplayState ? 'start' : 'stop',
            timestamp: Date.now(),
            source: 'presenter'
        }));
        localStorage.setItem('sf01_autoplayState', autoplayState ? 'active' : 'inactive');
    }
    
    // フル同期の実行
    function performFullSync() {
        try {
            console.log('フル同期を実行');
            
            // スライド番号を同期
            localStorage.setItem('sf01_currentSlide', window.currentSlide.toString());
            
            // 自動再生状態を同期
            localStorage.setItem('sf01_autoplayState', window.autoplayMode ? 'active' : 'inactive');
            
            // 同期コマンド
            const syncCommand = {
                action: 'fullSync',
                slide: window.currentSlide,
                autoplayState: window.autoplayMode,
                timestamp: Date.now(),
                source: 'presenter'
            };
            
            localStorage.setItem('syncCommand', JSON.stringify(syncCommand));
            
            showStatusNotification('フル同期を実行しました');
            
        } catch (e) {
            console.error('フル同期中にエラー:', e);
        }
    }
    
    // 同期機能の強化 (ストレージイベントリスナー)
    function enhanceSynchronization() {
        console.log('同期機能を強化します');
        
        window.addEventListener('storage', function(e) {
            try {
                // 同期コマンドの処理
                if (e.key === 'syncCommand') {
                    const syncData = JSON.parse(e.newValue);
                    
                    // 自分自身からのコマンドは無視
                    if (syncData.source === 'presenter') return;
                    
                    console.log('同期コマンドを受信しました:', syncData);
                    
                    // スライド変更の処理
                    if ((syncData.action === 'slideChange' || syncData.action === 'fullSync') && syncData.slide) {
                        const slideNum = parseInt(syncData.slide);
                        if (!isNaN(slideNum) && slideNum > 0) {
                            console.log(`スライドを ${slideNum} に変更します`);
                            window.currentSlide = slideNum;
                            updatePresenterView();
                        }
                    }
                    
                    // 自動再生状態の処理
                    if ((syncData.action === 'autoplayChange' || syncData.action === 'fullSync') && syncData.state !== undefined) {
                        const newState = !!syncData.state;
                        console.log(`自動再生状態を ${newState ? 'オン' : 'オフ'} に設定します`);
                        
                        // 状態を設定
                        window.autoplayMode = newState;
                        
                        // UI更新
                        const autoplayBtn = document.getElementById('autoplay-btn');
                        if (autoplayBtn) {
                            if (newState) {
                                autoplayBtn.classList.add('active');
                                autoplayBtn.textContent = '自動再生停止';
                            } else {
                                autoplayBtn.classList.remove('active');
                                autoplayBtn.textContent = '自動再生';
                            }
                        }
                    }
                }
                
                // スライド番号の直接同期
                if (e.key === 'sf01_currentSlide') {
                    const slideNum = parseInt(e.newValue);
                    if (!isNaN(slideNum) && slideNum > 0) {
                        console.log(`スライド番号の直接同期: ${slideNum}`);
                        window.currentSlide = slideNum;
                        updatePresenterView();
                    }
                }
                
                // 自動再生状態の直接同期 (メイン画面からの変更を監視)
                if (e.key === 'sf01_autoplayState') {
                    const stateValue = e.newValue;
                    console.log('Presenter: Received sf01_autoplayState from storage:', stateValue);
                    const newAutoplayMode = stateValue === 'active';

                    if (window.autoplayMode !== newAutoplayMode) {
                        window.autoplayMode = newAutoplayMode;
                        window.globalAutoplayState = newAutoplayMode;
                        if(window.SlideshowCore) window.SlideshowCore.setAutoplayState(newAutoplayMode);

                        const autoplayBtn = document.getElementById('autoplay-btn');
                        if (autoplayBtn) {
                            autoplayBtn.textContent = newAutoplayMode ? '自動再生停止' : '自動再生';
                            if (newAutoplayMode) {
                                autoplayBtn.classList.add('active');
                            } else {
                                autoplayBtn.classList.remove('active');
                            }
                        }
                        showNotification(`自動再生状態を同期: ${newAutoplayMode ? 'オン' : 'オフ'}`);
                    }
                }
                
            } catch (err) {
                console.error('同期処理中にエラー:', err);
            }
        });
        
        syncInitialized = true;
        console.log('同期機能の強化が完了しました');
    }
    
    // 状態通知の表示
    function showStatusNotification(message) {
        try {
            // 既存の通知要素があれば使用
            let notification = document.getElementById('status-notification');
            
            // なければ作成
            if (!notification) {
                notification = document.createElement('div');
                notification.id = 'status-notification';
                notification.style.position = 'fixed';
                notification.style.bottom = '70px';
                notification.style.right = '20px';
                notification.style.backgroundColor = 'rgba(0, 100, 200, 0.9)';
                notification.style.color = 'white';
                notification.style.padding = '10px 20px';
                notification.style.borderRadius = '5px';
                notification.style.zIndex = '1000';
                notification.style.transition = 'opacity 0.5s';
                notification.style.opacity = '0';
                document.body.appendChild(notification);
            }
            
            // メッセージを設定して表示
            notification.textContent = message;
            notification.style.opacity = '1';
            
            // 3秒後に非表示
            setTimeout(() => {
                notification.style.opacity = '0';
            }, 3000);
            
        } catch (e) {
            console.error('通知表示でエラー:', e);
        }
    }
    
    // プレゼンタースライド表示の修正
    function fixSlideImages() {
        try {
            console.log('プレゼンタースライド表示を修正します');
            
            // スライドプレビュー要素を取得
            const currentSlidePreview = document.querySelector('.current-slide-preview');
            const nextSlidePreview = document.querySelector('.next-slide-preview');
            
            if (!currentSlidePreview || !nextSlidePreview) {
                console.warn('スライドプレビュー要素が見つかりません');
                return false;
            }
            
            // 現在のスライド番号を取得
            const currentSlide = window.currentSlide || 1;
            
            // 画像要素を作成または更新
            function createOrUpdateImage(container, slideNumber) {
                // 既存の画像要素があるか確認
                let imgElement = container.querySelector('img');
                
                // なければ作成
                if (!imgElement) {
                    imgElement = document.createElement('img');
                    imgElement.className = 'slide-image';
                    imgElement.style.maxWidth = '100%';
                    imgElement.style.maxHeight = '100%';
                    imgElement.style.objectFit = 'contain';
                    container.appendChild(imgElement);
                }
                
                // 画像ソースを設定
                const paddedNumber = String(slideNumber).padStart(2, '0');
                imgElement.src = `salesforce_slides/salesforce_slides01/slide${paddedNumber}.png`;
                imgElement.alt = `スライド ${slideNumber}`;
                imgElement.onerror = function() {
                    console.warn(`スライド ${slideNumber} の画像読み込みに失敗しました`);
                    this.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMzAwIiBoZWlnaHQ9IjIwMCIgZmlsbD0iI2VlZSIvPjx0ZXh0IHg9IjUwJSIgeT0iNTAlIiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMjQiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGZpbGw9IiM5OTkiPuOCueODqeOCpOODiSAnICsgc2xpZGVOdW1iZXIgKyAnPC90ZXh0Pjwvc3ZnPg==';
                };
                
                return imgElement;
            }
            
            // 現在のスライド画像を更新/作成
            const currentImg = createOrUpdateImage(currentSlidePreview, currentSlide);
            
            // 次のスライド画像を更新/作成（最後のスライドでない場合）
            if (currentSlide < (window.totalSlides || 11)) {
                const nextImg = createOrUpdateImage(nextSlidePreview, currentSlide + 1);
                nextSlidePreview.style.display = 'block';
            } else {
                nextSlidePreview.style.display = 'none';
            }
            
            // スタイルを追加
            const styleId = 'enhanced-presenter-styles';
            if (!document.getElementById(styleId)) {
                const style = document.createElement('style');
                style.id = styleId;
                style.textContent = `
                    .current-slide-preview, .next-slide-preview {
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        min-height: 200px;
                        background-color: #f0f0f0;
                        overflow: hidden;
                        position: relative;
                    }
                    
                    .slide-image {
                        max-width: 100%;
                        max-height: 100%;
                        object-fit: contain;
                        display: block;
                    }
                    
                    #prev-btn, #next-btn, #autoplay-btn, #sync-btn {
                        cursor: pointer;
                        position: relative;
                        z-index: 100;
                    }
                `;
                document.head.appendChild(style);
            }
            
            console.log('スライド表示修正完了');
            showStatusNotification('スライド表示を修正しました');
            return true;
            
        } catch (e) {
            console.error('スライド表示修正中にエラー:', e);
            return false;
        }
    }
    
    // 初期化処理
    function init() {
        if (initialized) return;
        console.log('プレゼンター画面: 初期化処理を開始します');
        
        // 初期化フラグを設定
        window.autoplayMode = false;
        
        // スライド表示を修正
        fixSlideImages();
        
        // ボタンを修復
        fixButtons();
        
        // 同期機能を強化
        enhanceSynchronization();
        
        // 既存の関数をバックアップ
        if (typeof window.updatePresenterView === 'function' && !window.originalUpdatePresenterView) {
            window.originalUpdatePresenterView = window.updatePresenterView;
        }
        
        // 強化した関数に置き換え
        window.updatePresenterView = updatePresenterView;
        window.syncWithMainWindow = syncWithMainWindow;
        window.performFullSync = performFullSync;
        
        // 定期的な状態チェック
        setInterval(() => {
            // ボタンの状態を再確認
            if (!buttonFixed) fixButtons();
            
            // 同期状態を再確認
            if (!syncInitialized) enhanceSynchronization();
            
            // スライド表示を確認
            const currentImg = document.querySelector('.current-slide-preview img');
            if (!currentImg || !currentImg.complete) {
                fixSlideImages();
            }
            
        }, 5000);
        
        initialized = true;
        console.log('プレゼンター画面: 初期化処理が完了しました');
        showStatusNotification('プレゼンター画面の初期化が完了しました');
    }
    
    // ページの読み込み時に初期化
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(init, 500); // 少し遅延させて他のスクリプトが読み込まれるようにする
        });
    } else {
        // DOMがすでに読み込まれている場合は遅延実行
        setTimeout(init, 500);
    }
    
    // 完全読み込み後にも初期化を確認
    window.addEventListener('load', () => {
        setTimeout(init, 1000); // 遅延して確実にすべてが読み込まれた後に実行
        
        // 初回の同期要求を送信
        setTimeout(() => {
            if (initialized) {
                performFullSync();
            }
        }, 2000);
    });
    
    // 初期化を強制実行するAPI
    window.forceFixPresenter = init;
})();
</script>
</body>
</html>
